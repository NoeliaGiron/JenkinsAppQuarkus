pipeline {
    agent any
    
    environment {
        APP_NAME = 'hola-noelia'
        APP_VERSION = '1.0.0-SNAPSHOT'
        QUARKUS_VERSION = '3.6.3'
        MAVEN_VERSION = '3.9.6'
    }
    
    stages {
        stage('Setup Tools') {
            steps {
                echo 'üîß Configurando herramientas...'
                script {
                    // Instalar Maven si no est√° disponible
                    sh '''
                        if ! command -v mvn &> /dev/null; then
                            echo "üì¶ Instalando Maven..."
                            # Descargar Maven
                            wget https://archive.apache.org/dist/maven/maven-3/${MAVEN_VERSION}/binaries/apache-maven-${MAVEN_VERSION}-bin.tar.gz
                            tar -xzf apache-maven-${MAVEN_VERSION}-bin.tar.gz
                            export PATH=$PATH:$(pwd)/apache-maven-${MAVEN_VERSION}/bin
                            echo "‚úÖ Maven instalado en: $(pwd)/apache-maven-${MAVEN_VERSION}/bin"
                        else
                            echo "‚úÖ Maven ya est√° instalado"
                        fi
                        
                        # Verificar Java
                        if ! command -v java &> /dev/null; then
                            echo "‚ùå Java no est√° instalado. Instalando OpenJDK..."
                            apt-get update && apt-get install -y openjdk-17-jdk
                        else
                            echo "‚úÖ Java est√° disponible"
                        fi
                        
                        echo "üîß Verificando herramientas:"
                        java --version
                        mvn --version
                        git --version
                    '''
                }
            }
        }
        
        stage('Checkout') {
            steps {
                echo 'üîç Verificando c√≥digo fuente...'
                checkout scm
                
                script {
                    // Mostrar informaci√≥n del build
                    echo "üìã Informaci√≥n del Build:"
                    echo "  - Proyecto: ${env.JOB_NAME}"
                    echo "  - Build: ${env.BUILD_NUMBER}"
                    echo "  - Branch: ${env.GIT_BRANCH}"
                    echo "  - Commit: ${env.GIT_COMMIT}"
                    echo "  - Versi√≥n: ${env.APP_VERSION}"
                    echo "  - Quarkus: ${env.QUARKUS_VERSION}"
                }
            }
        }
        
        stage('Validate') {
            steps {
                echo '‚úÖ Validando proyecto Maven...'
                script {
                    sh '''
                        # Usar Maven del PATH o del directorio descargado
                        if command -v mvn &> /dev/null; then
                            mvn validate
                        else
                            ./apache-maven-${MAVEN_VERSION}/bin/mvn validate
                        fi
                    '''
                }
            }
        }
        
        stage('Compile') {
            steps {
                echo 'üî® Compilando aplicaci√≥n Quarkus...'
                script {
                    sh '''
                        if command -v mvn &> /dev/null; then
                            mvn compile
                        else
                            ./apache-maven-${MAVEN_VERSION}/bin/mvn compile
                        fi
                    '''
                }
            }
        }
        
        stage('Test') {
            steps {
                echo 'üß™ Ejecutando pruebas...'
                script {
                    sh '''
                        if command -v mvn &> /dev/null; then
                            mvn test
                        else
                            ./apache-maven-${MAVEN_VERSION}/bin/mvn test
                        fi
                    '''
                }
            }
            post {
                always {
                    echo 'üìä Generando reportes de pruebas...'
                    publishTestResults testResultsPattern: '**/target/surefire-reports/*.xml'
                }
            }
        }
        
        stage('Package') {
            steps {
                echo 'üì¶ Empaquetando aplicaci√≥n...'
                script {
                    sh '''
                        if command -v mvn &> /dev/null; then
                            mvn clean package -DskipTests
                        else
                            ./apache-maven-${MAVEN_VERSION}/bin/mvn clean package -DskipTests
                        fi
                    '''
                }
            }
        }
        
        stage('Archive Artifacts') {
            steps {
                echo 'üìÅ Archivando artefactos...'
                archiveArtifacts artifacts: 'target/*.jar', fingerprint: true
                archiveArtifacts artifacts: 'target/quarkus-app/**/*', fingerprint: true
                
                script {
                    // Crear archivo de informaci√≥n del build
                    sh '''
                        echo "Build Information" > build-info.txt
                        echo "=================" >> build-info.txt
                        echo "Project: ${JOB_NAME}" >> build-info.txt
                        echo "Build: ${BUILD_NUMBER}" >> build-info.txt
                        echo "Version: ${APP_VERSION}" >> build-info.txt
                        echo "Branch: ${GIT_BRANCH}" >> build-info.txt
                        echo "Commit: ${GIT_COMMIT}" >> build-info.txt
                        echo "Date: $(date)" >> build-info.txt
                        echo "Quarkus Version: ${QUARKUS_VERSION}" >> build-info.txt
                    '''
                    archiveArtifacts artifacts: 'build-info.txt', fingerprint: true
                }
            }
        }
        
        stage('Success Info') {
            steps {
                echo 'üéâ Informaci√≥n de √©xito...'
                script {
                    sh '''
                        echo "=========================================="
                        echo "üéâ ¬°Pipeline completado exitosamente!"
                        echo "=========================================="
                        echo ""
                        echo "üì¶ Artefactos generados:"
                        echo "  - JAR: target/hola-noelia-1.0.0-SNAPSHOT.jar"
                        echo "  - App: target/quarkus-app/"
                        echo ""
                        echo "üöÄ Para ejecutar:"
                        echo "  java -jar target/quarkus-app/quarkus-run.jar"
                        echo ""
                        echo "üåê Endpoints:"
                        echo "  - http://localhost:8080/ (redirect)"
                        echo "  - http://localhost:8080/hola/web (web)"
                        echo "  - http://localhost:8080/hola (texto)"
                        echo "  - http://localhost:8080/hola/json (JSON)"
                        echo ""
                        echo "üê≥ Docker:"
                        echo "  docker build -t hola-noelia ."
                        echo "  docker run -p 8080:8080 hola-noelia"
                        echo ""
                        echo "üìä Build: ${BUILD_URL}"
                        echo "=========================================="
                    '''
                }
            }
        }
    }
    
    post {
        always {
            echo 'üßπ Limpiando workspace...'
            cleanWs()
        }
        success {
            echo '‚úÖ Pipeline completado exitosamente!'
            script {
                // Notificaciones de √©xito
                emailext (
                    subject: "‚úÖ Pipeline SUCCESS: ${env.JOB_NAME} [${env.BUILD_NUMBER}]",
                    body: """
                        <h2>Pipeline Completado Exitosamente</h2>
                        <p><strong>Proyecto:</strong> ${env.JOB_NAME}</p>
                        <p><strong>Build:</strong> ${env.BUILD_NUMBER}</p>
                        <p><strong>Branch:</strong> ${env.GIT_BRANCH}</p>
                        <p><strong>Commit:</strong> ${env.GIT_COMMIT}</p>
                        <p><strong>Duraci√≥n:</strong> ${currentBuild.durationString}</p>
                        
                        <h3>üéØ Aplicaci√≥n Quarkus</h3>
                        <p><strong>Nombre:</strong> ${env.APP_NAME}</p>
                        <p><strong>Versi√≥n:</strong> ${env.APP_VERSION}</p>
                        <p><strong>Quarkus:</strong> ${env.QUARKUS_VERSION}</p>
                        
                        <h3>üöÄ Para ejecutar:</h3>
                        <p><code>java -jar target/quarkus-app/quarkus-run.jar</code></p>
                        
                        <h3>üåê Endpoints:</h3>
                        <ul>
                            <li><a href="http://localhost:8080/">Interfaz Principal</a></li>
                            <li><a href="http://localhost:8080/hola/web">Interfaz Web</a></li>
                            <li><a href="http://localhost:8080/hola">API Texto</a></li>
                            <li><a href="http://localhost:8080/hola/json">API JSON</a></li>
                        </ul>
                        
                        <h3>üîó Enlaces</h3>
                        <ul>
                            <li><a href="${env.BUILD_URL}">Ver Build</a></li>
                            <li><a href="${env.BUILD_URL}console">Ver Logs</a></li>
                        </ul>
                    """,
                    recipientProviders: [[$class: 'DevelopersRecipientProvider']]
                )
            }
        }
        failure {
            echo '‚ùå Pipeline fall√≥!'
            script {
                // Notificaciones de fallo
                emailext (
                    subject: "‚ùå Pipeline FAILED: ${env.JOB_NAME} [${env.BUILD_NUMBER}]",
                    body: """
                        <h2>Pipeline Fall√≥</h2>
                        <p><strong>Proyecto:</strong> ${env.JOB_NAME}</p>
                        <p><strong>Build:</strong> ${env.BUILD_NUMBER}</p>
                        <p><strong>Branch:</strong> ${env.GIT_BRANCH}</p>
                        <p><strong>Commit:</strong> ${env.GIT_COMMIT}</p>
                        <p><strong>Duraci√≥n:</strong> ${currentBuild.durationString}</p>
                        
                        <h3>üîç Para m√°s detalles:</h3>
                        <ul>
                            <li><a href="${env.BUILD_URL}">Ver Build</a></li>
                            <li><a href="${env.BUILD_URL}console">Ver Logs</a></li>
                        </ul>
                    """,
                    recipientProviders: [[$class: 'DevelopersRecipientProvider']]
                )
            }
        }
        cleanup {
            echo 'üßπ Limpieza final...'
        }
    }
} 